{{ define "main" }}
  <div class="main blog-page">
    {{.Content}}

    {{ $paginator := (.Paginate (where .Site.RegularPages "Type" "posts") 12) }}
    {{ $pages := $paginator.Pages }}
    {{ $isFirstPage := eq $paginator.PageNumber 1 }}

    {{/* Article Featured uniquement sur la page 1 */}}
    {{ if and $isFirstPage (gt (len $pages) 0) }}
      {{ $featured := index $pages 0 }}
      {{ $image := $featured.Resources.GetMatch "cover" | default (index ($featured.Resources.ByType "image") 0) }}
      {{ if $image }}
        {{ $web := $image.Fit "1600x1200 center" }}
        {{/* Mois en français */}}
        {{ $months := dict "January" "Janvier" "February" "Février" "March" "Mars" "April" "Avril" "May" "Mai" "June" "Juin" "July" "Juillet" "August" "Août" "September" "Septembre" "October" "Octobre" "November" "Novembre" "December" "Décembre" }}
        {{ $monthEn := $featured.Date.Format "January" }}
        {{ $monthFr := index $months $monthEn }}
        {{ $year := $featured.Date.Format "2006" }}
        {{ $dateFr := printf "%s %s" $monthFr $year }}
        <article class="featured-article" data-category="{{ (index $featured.Params.categories 0) | urlize }}">
          <a href="{{ $featured.Permalink }}" class="featured-link">
            <div class="featured-image">
              <img src="{{ $web.Permalink }}" alt="{{ $featured.Title }}" loading="lazy">
              <div class="featured-overlay">
                <div class="featured-meta">
                  {{ with index $featured.Params.categories 0 }}
                    <span class="featured-category">{{ . | upper }}</span>
                  {{ end }}
                  <span class="featured-separator">•</span>
                  <span class="featured-date">{{ $dateFr | upper }}</span>
                </div>
                <h2 class="featured-title">{{ $featured.Title }}</h2>
              </div>
            </div>
          </a>
        </article>
      {{ end }}
    {{ end }}

    {{/* Section Récent */}}
    <section class="recent-section">
      <h3 class="section-title">Récent</h3>

      {{/* Filtres par catégorie - sous le titre et la barre */}}
      <div class="category-filters">
        <button class="filter-btn active" data-filter="all">Tous</button>
        {{ range $.Site.Taxonomies.categories }}
          {{ $name := .Page.Title }}
          {{ $count := len .Pages }}
          {{ if gt $count 0 }}
            <button class="filter-btn" data-filter="{{ $name | urlize }}">{{ $name }} <span class="count">({{ $count }})</span></button>
          {{ end }}
        {{ end }}
      </div>

      <div class="posts-list">
        {{/* Mois en français */}}
        {{ $months := dict "January" "Janvier" "February" "Février" "March" "Mars" "April" "Avril" "May" "Mai" "June" "Juin" "July" "Juillet" "August" "Août" "September" "Septembre" "October" "Octobre" "November" "Novembre" "December" "Décembre" }}
        {{/* Sur page 1, on skip le premier article (featured), sinon on affiche tout */}}
        {{ $articlesToShow := $pages }}
        {{ if $isFirstPage }}
          {{ $articlesToShow = after 1 $pages }}
        {{ end }}
        {{ range $index, $post := $articlesToShow }}
          {{ $categories := $post.Params.categories }}
          {{ $catSlug := "" }}
          {{ with index $categories 0 }}
            {{ $catSlug = . | urlize }}
          {{ end }}
          {{/* Date en français */}}
          {{ $monthEn := $post.Date.Format "January" }}
          {{ $monthFr := index $months $monthEn }}
          {{ $year := $post.Date.Format "2006" }}
          {{ $dateFr := printf "%s %s" $monthFr $year }}
          <article class="post-item" data-category="{{ $catSlug }}">
            {{ $image := $post.Resources.GetMatch "cover" | default (index ($post.Resources.ByType "image") 0) }}
            {{ if $image }}
              {{ $thumb := $image.Fill "800x200 center" }}
              <a href="{{ $post.Permalink }}" class="post-item-link">
                <div class="post-item-image">
                  <img src="{{ $thumb.Permalink }}" alt="{{ $post.Title }}" loading="lazy">
                  <div class="post-item-overlay">
                    <div class="post-item-meta">
                      {{ with index $categories 0 }}
                        <span class="post-item-category">{{ . | upper }}</span>
                      {{ end }}
                      <span class="post-item-separator">•</span>
                      <span class="post-item-date">{{ $dateFr | upper }}</span>
                    </div>
                    <h3 class="post-item-title">{{ $post.Title }}</h3>
                  </div>
                </div>
              </a>
            {{ end }}
          </article>
        {{ end }}
      </div>
    </section>

    <div class="pagination-container">
      {{ template "_internal/pagination.html" . }}
    </div>
  </div>

  <script>
  // Filtres par catégorie
  document.addEventListener('DOMContentLoaded', function() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    const articles = document.querySelectorAll('.post-item[data-category]');
    const featuredArticle = document.querySelector('.featured-article');
    const paginationContainer = document.querySelector('.pagination-container');

    filterBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const filter = this.dataset.filter;

        // Activer le bouton
        filterBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // Gérer la pagination et le featured
        if (filter === 'all') {
          // Afficher pagination et featured
          if (paginationContainer) paginationContainer.style.display = '';
          if (featuredArticle) featuredArticle.style.display = '';
        } else {
          // Cacher pagination et featured quand on filtre
          if (paginationContainer) paginationContainer.style.display = 'none';
          if (featuredArticle) featuredArticle.style.display = 'none';
        }

        // Filtrer les articles
        articles.forEach(article => {
          if (filter === 'all' || article.dataset.category === filter) {
            article.style.display = '';
          } else {
            article.style.display = 'none';
          }
        });
      });
    });
  });
  </script>
{{ end }}
