{{ define "main" }}
  <div class="mb-8 container max-w-4xl mx-auto">
      <p class="text-center mx-4 md:mx-0">
        {{.Content}}
      </p>
  </div>

{{/* Collecter toutes les ressources media (images + videos) */}}
{{ $allmedia := slice }}

{{/* Images */}}
{{ range sort (.Resources.ByType "image") "Name" "desc"}}
  {{ $w := mul .Width 1.0 }}
  {{ $h := mul .Height 1.0 }}
  {{ $ratio := div $h $w }}
  {{ $allmedia = $allmedia | append (dict "Src" . "Kind" "image" "W" .Width "H" .Height "Ratio" $ratio "SortName" .Name) }}
{{ end }}

{{/* Videos MP4 */}}
{{ range sort (.Resources.Match "*.mp4") "Name" "desc"}}
  {{ $name := .Name }}
  {{ $ratio := 0.5625 }}
  {{ if gt (len (findRE "_16x9" $name)) 0 }}
    {{ $ratio = 0.5625 }}
  {{ else if gt (len (findRE "_9x16" $name)) 0 }}
    {{ $ratio = 1.7778 }}
  {{ else if gt (len (findRE "_4x3" $name)) 0 }}
    {{ $ratio = 0.75 }}
  {{ else if gt (len (findRE "_3x4" $name)) 0 }}
    {{ $ratio = 1.3333 }}
  {{ else if gt (len (findRE "_1x1" $name)) 0 }}
    {{ $ratio = 1.0 }}
  {{ else if gt (len (findRE "_4x5" $name)) 0 }}
    {{ $ratio = 1.25 }}
  {{ else if gt (len (findRE "_5x4" $name)) 0 }}
    {{ $ratio = 0.8 }}
  {{ end }}
  {{ $allmedia = $allmedia | append (dict "Src" . "Kind" "video" "Ratio" $ratio "SortName" .Name) }}
{{ end }}

{{/* Trier par nom decroissant */}}
{{ $allmedia = sort $allmedia "SortName" "desc" }}

{{/* Grille flex avec ratios preserves */}}
<div data-pswp class="w-full px-4 md:px-6">
  <div class="mgrid md:flex flex-wrap justify-end">
    {{ $total := len $allmedia }}
    {{ range $index, $item := $allmedia }}
      {{ $pos := mod $index 3 }}
      {{ $rowStart := sub $index $pos }}

      {{/* Ratios par defaut */}}
      {{ $r1 := 0.6667 }}
      {{ $r2 := 0.6667 }}
      {{ $r3 := 0.6667 }}

      {{/* Item 1 de la ligne */}}
      {{ if lt $rowStart $total }}
        {{ $r1 = (index $allmedia $rowStart).Ratio }}
      {{ end }}

      {{/* Item 2 de la ligne */}}
      {{ $idx2 := add $rowStart 1 }}
      {{ if lt $idx2 $total }}
        {{ $r2 = (index $allmedia $idx2).Ratio }}
      {{ end }}

      {{/* Item 3 de la ligne */}}
      {{ $idx3 := add $rowStart 2 }}
      {{ $has3 := lt $idx3 $total }}
      {{ if $has3 }}
        {{ $r3 = (index $allmedia $idx3).Ratio }}
      {{ end }}

      {{/* Calculer les largeurs proportionnelles */}}
      {{ $inv1 := div 1.0 $r1 }}
      {{ $inv2 := div 1.0 $r2 }}
      {{ $inv3 := 0.0 }}
      {{ if $has3 }}
        {{ $inv3 = div 1.0 $r3 }}
      {{ end }}

      {{ $sum := add $inv1 $inv2 }}
      {{ if $has3 }}
        {{ $sum = add $sum $inv3 }}
      {{ end }}

      {{ $myInv := div 1.0 $item.Ratio }}
      {{ $flexPct := mul (div $myInv $sum) 100 }}
      {{ $pb := mul $item.Ratio 100 }}

      <div class="flex flex-col min-h-full inherit" style="flex:1 0 {{ $flexPct }}%">
        <div style="flex:1 0 100%">
          {{ if eq $item.Kind "video" }}
            <div style="padding-bottom:{{ $pb }}%" class="relative box-border block">
              <video autoplay loop muted playsinline
                     class="absolute top-0 left-0 w-full h-full object-cover"
                     src="{{ $item.Src.RelPermalink }}">
              </video>
            </div>
          {{ else }}
            {{ $src := $item.Src }}
            {{ $xs := "20x" }}
            {{ $md := "800x" }}
            {{ $lqip := $src.Resize (printf "%s webp" $xs) }}
            {{ $small := $src.Resize (printf "%s webp" $md) }}
            {{ if eq $src.MediaType.SubType "gif" }}
              {{ $lqip = $src.Resize (printf "%s" $xs) }}
              {{ $small = $src }}
            {{ end }}
            <picture style="padding-bottom:{{ $pb }}%" class="relative box-border block">
              <img
                loading="lazy"
                style="background: url(data:image/webp;base64,{{ $lqip.Content | base64Encode }}); background-size: cover"
                alt=""
                class="cursor-pointer object-cover lazy absolute top-0 left-0 w-full h-full"
                data-action="zoom"
                data-zoom-src="{{ $src.RelPermalink }}"
                src="{{ $small.RelPermalink }}"
                width="{{ $src.Width }}" height="{{ $src.Height }}"/>
            </picture>
          {{ end }}
        </div>
      </div>
    {{ end }}
  </div>
</div>
{{ end }}
